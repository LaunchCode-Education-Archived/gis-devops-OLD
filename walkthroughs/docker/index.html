<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>An Introduction to Docker :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-an-introduction-to-docker'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>An Introduction to Docker</h1>
                    <p>Follow along with the instructor as you explore Docker and configure a basic Flask application.</p>
<h2 id="setup">Setup</h2>
<p>First, make sure that you have Docker installed.  You can check the Docker installation by running</p>
<pre><code>$ docker --version</code></pre>
<p>Also, make sure that you have Python and Redis installed. Mac OS X High Sierra should come with Python 2.7 installed right out of the box.  Double check by running:</p>
<pre><code>$ python --version</code></pre>
<p>You will need to install <code>pip</code>.  <code>pip</code> is how Python installs libraries.</p>
<pre><code>$ sudo easy_install pip</code></pre>
<p>Redis is a key value NoSQL database.  Install it with Homebrew.</p>
<pre><code>$ brew install redis
$ brew services start redis</code></pre>
<p>Double check that it is running on port <code>6379</code>.</p>
<pre><code>$ telnet localhost 6379</code></pre>
<h2 id="a-simple-python-web-app">A simple Python web app</h2>
<p>In this walkthrough we are going to stand up a simple Python web app.  The app uses Python Flask as a web server.  Flask may be new to you, but see if you see any similarities to Spring Boot.</p>
<p>Check out the [docker-flask-walkthrough]()</p>
<p>First let's run the file called <code>simple_app.py</code>. Be sure to install all of the app dependencies using pip first!</p>
<pre><code>$ pip install --user -r requirements.tx</code></pre>
<p><code>simple_app.py</code></p>
<pre><code>import time

from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World!'

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)</code></pre>
<p>Fire up the app by running the following command:</p>
<pre><code>$ python app.py</code></pre>
<p>Navigating to <code>http://localhost:5000</code> should show our simple message.  Now let's turn this app into a Docker container.</p>
<p>We need to create a <code>Dockerfile</code> for CentOS. We'll start with the very basics and work our way up.  We'll use the <code>ADD</code> command to inject our local directory into the container at the path <code>/code</code>.</p>
<p><code>Dockerfile</code></p>
<pre><code>FROM centos:7

ADD . /code</code></pre>
<p>Build the image and then check to make sure that it built correctly:</p>
<pre><code>$ sudo docker build --tag my-centos .
$ sudo docker images 
REPOSITORY                                      TAG                 IMAGE ID            CREATED             SIZE
my-centos                                       latest              ff426288ea90        8 weeks ago         207MB</code></pre>
<p>Great. We can exactly when it was created and how large the image is.</p>
<p>Since the <code>Dockerfile</code> doesn't have a command to start a process, let's start the container on the terminal using the <code>-i -t</code> flags and the command <code>/bin/bash</code>.  Also, we will use the <code>-p 5000:5000</code> option to map port 5000 on the host machine to port 5000 inside the docker container.</p>
<pre><code>$ sudo docker run -i -t -p 5000:5000 my-centos /bin/bash
$ [root@7b3cfec32b83 /]#</code></pre>
<p>Now that we have the terminal, we can <strong>manually</strong> walk though the setup steps before we script them into the <code>Dockerfile</code>.</p>
<pre><code>$ yum -y install epel-release
$ yum -y update
$ yum -y install python-pip
$ pip install --upgrade pip 
$ pip install -r /code/requirements.txt
$ python /code/simple_app.py</code></pre>
<p>Check it out in the browser, <a href="http://127.0.0.1:5000" target="_blank">http://127.0.0.1:5000</a>.</p>
<p>Now it is time to convert our manual walkthrough into a <code>Dockerfile</code>. For any command we want to execute, we have to prepend <code>RUN</code> to the line.  For any command we want to leave running as a process, we want to append <code>CMD</code>.  Your <code>Dockerfile</code> should look like this:</p>
<pre><code># start with the centos 7 base image
FROM centos:7 

# add in our code
ADD . /code

# install and upgrade software
RUN yum -y install epel-release
RUN yum -y update
RUN yum -y install python-pip
RUN pip install --upgrade pip
RUN pip install -r /code/requirements.txt

# Run the web app as the main process
CMD ["python", "/code/simple_app.py"]</code></pre>
<p>We'll need to rebuild our Docker image and relaunch the our container.</p>
<pre><code>$ sudo docker build --tag my-centos .
$ sudo docker run -i -t -p 5000:5000 my-centos</code></pre>
<p>Check the browser again and see if the site is still up.  </p>
<aside class="aside-note">
<p>Note: The previous Docker container was running in the foreground.  If you want to run the Docker container as a <em>daemon</em> use the <code>-d</code> flag.</p>
</aside>
<h3 id="a-more-complex-python-app">A more complex Python app</h3>
<p>In the next section of the walkthrough, we are going to stand up a more complex Flask app.  In this app, we are going to integrate the key-value database Redis.  In order to integrate Redis into the Flask web app, we will need to leverage Docker's <code>network</code> capabilities.</p>
<p>Take a look at the <code>app.py</code>.</p>
<pre><code>import time

import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)

def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)

@app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World! I have been seen {} times.\n'.format(count)

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)</code></pre>
<p>The code uses a Redis database to keep track of the number of visits to a particular page. Let's try and run to see the app in action:</p>
<pre><code>$ python app.py</code></pre>
<p>If you hit the web page <a href="http://127.0.0.1:5000" target="_blank">http://127.0.0.1:5000</a> you should see the following error message:</p>
<pre><code>Traceback (most recent call last):
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1997, in __call__
    return self.wsgi_app(environ, start_response)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1985, in wsgi_app
    response = self.handle_exception(e)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1540, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1982, in wsgi_app
    response = self.full_dispatch_request()
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1614, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1517, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1612, in full_dispatch_request
    rv = self.dispatch_request()
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1598, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "/Users/mikemenne/Code/LaunchCode/Examples/GisDevops/docker-flask-walkthrough/app.py", line 25, in hello
    count = get_hit_count()
  File "/Users/mikemenne/Code/LaunchCode/Examples/GisDevops/docker-flask-walkthrough/app.py", line 18, in get_hit_count
    raise exc
ConnectionError: Error 61 connecting to redis:6379. Connection refused.</code></pre>
<p>It looks like the app is not able to connect to <code>redis:6379</code>.  Let's do a <code>telnet</code> to check if the port is open and being listened to:</p>
<pre><code>$ telnet redis 6379
redis: nodename nor servname provided, or not known</code></pre>
<p>Nada... The URL <code>redis</code> doesn't even exist.  This can be fixed.  All Linux systems can use the <code>/etc/hosts</code> file to override URLs in the browser.  Open up <code>/etc/hosts</code> and add an entry for <code>redis</code>.</p>
<pre><code>$ sudo vi /etc/hosts
# Host Database
#
# localhost is used to configure the loopback interface
# when the system is booting.  Do not change this entry.
##
127.0.0.1 localhost
255.255.255.255 broadcasthost
::1             localhost 
127.0.0.1 redis</code></pre>
<aside class="aside-note">
<p>Note:  If you ever get a hold of your friend's root password, it can be good fun to mess with their <code>/etc/hosts</code> file.  You can redirect <code>google.com</code> to just about any site that you want.  </p>
</aside>
<p>Now if you <code>telnet redis 6379</code> it should redirect you to the <code>localhost</code> where your Redis instance is running.  Run the app again to see it in action. Each time you hit the page you should see the counter increase.</p>
<pre><code>$ python app.py
$ curl -XGET localhost:5000
Hello World! I have been seen 1 times.
$ curl -XGET localhost:5000
Hello World! I have been seen 2 times.
$ curl -XGET localhost:5000
Hello World! I have been seen 3 times.</code></pre>
<p>Great.  Let's make this a Docker container now. This is where Docker Compose can help us in a big way.  Docker Compose takes care of all of the <code>/etc/host/</code> changes behind the scenes so that we can just reference a container by its name.  </p>
<p>Here is a <code>docker-compose.yml</code> that allows the Flask app to reference the Redis container.</p>
<pre><code>version: '3'
services:
  web:
    build: .
    ports:
     - "5000:5000"
  redis:
    image: "redis:alpine"</code></pre>
<p>Remember, we don't have to make any changes to the <code>app.py</code> file.  Inside of the containers, Docker Compose is handling the local DNS so that any reference to <code>redis</code> gets redirected to the <code>redis</code> container.</p>
<p>Use the following command to stand up the two containers:</p>
<pre><code>$ docker-compose up -d</code></pre>
<p>You should see the app come up on <code>localhost:5000</code>. Notice that only the Python Flask server has access to the Redis server at <code>6379</code>, but you can't <code>telnet localhost 6379</code>.  This is because we did not forward the port of the Redis server.  Add the following config to your <code>docker-compose</code> to forward the port of the Redis server to the host machine:</p>
<pre><code>ports:
- "6379:6379"</code></pre>
<p>Notice also that Docker Compose is spinning up multiple containers on your behalf. Run:</p>
<pre><code>$ sudo docker ps 
</code></pre>
<p>Let's look at these containers a bit more indepth.  <code>docker logs {container name}</code> will show all of the logs that have been written to STDOUT. (replace {container name} with the actual container name).</p>
<pre><code>$ sudo docker logs {container name}</code></pre>
<p>Let's also take the container details.  <code>docker inspect {container name}</code> will show all of the details about the container including network information.</p>
<pre><code>$ sudo dockers inspect {container name}</code></pre>
<pre><code>version: '3'
services:
  web:
    build: .
    ports:
     - "5000:5000"
  redis:
    image: "redis:alpine"
    ports:
    - "6379:6379"</code></pre>
<aside class="aside-note">
<p>Be sure that the Redis server running via HomeBrew is turned of (<code>brew services stop redis</code>).</p>
</aside>
<p>Run <code>docker-compose down</code> to stop and remove the Docker containers.</p>
<aside class="aside-note">
<p>If you want to remove all of your unused containers run <code>sudo docker container prune</code></p>
</aside>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
