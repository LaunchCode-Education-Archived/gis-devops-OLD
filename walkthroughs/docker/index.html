<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>An Introduction to Docker :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-an-introduction-to-docker'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>An Introduction to Docker</h1>
                    <p>Follow along with the instructor as you explore Docker and configure a basic Flask application.</p>
<h2 id="docker-commands">Docker Commands</h2>
<ul>
<li><code>docker ps</code> see list of <strong>running</strong> containers</li>
<li><code>docker ps -a</code> see lisf of all containers, including ones that failed or were stopped</li>
<li><code>docker start &lt;container-name or id&gt;</code> starts the container</li>
<li><code>docker stop &lt;container-name or id&gt;</code> stops the container</li>
<li><code>docker restart &lt;container-name or id&gt;</code> restarts the container</li>
<li><code>docker rm &lt;container-name or id&gt;</code> removes the container</li>
<li><code>docker images</code> shows list of images that you have downloaded. containers are created from images</li>
<li><code>docker image rm &lt;image-name or id&gt;</code> removes an image</li>
<li><code>docker build --tag super-happy-fun-os .</code> builds a new image that containers can be created from</li>
<li><code>docker-compose up -d</code> uses a docker-compose.yml file to configure and start containers</li>
<li>For more info and more commands please see <a href="https://docs.docker.com/engine/reference/commandline/docker/" target="_blank">the Docker CLI docs</a></li>
</ul>
<h2 id="setup">Setup</h2>
<p>First, make sure that you have Docker installed.  You can check the Docker installation by running</p>
<pre><code>$ docker --version</code></pre>
<p>Also, make sure that you have Python and Redis installed. Mac OS X High Sierra should come with Python 2.7 installed right out of the box.  Double check by running:</p>
<pre><code>$ python --version</code></pre>
<p>You will need to install <code>pip</code>.  <code>pip</code> is how Python installs libraries.</p>
<pre><code>$ sudo easy_install pip</code></pre>
<p>Redis is a key value NoSQL database.  Install it with Homebrew.</p>
<pre><code>$ brew install redis
$ brew services start redis</code></pre>
<p>Double check that it is running on port <code>6379</code>.</p>
<pre><code>$ telnet localhost 6379</code></pre>
<h2 id="a-simple-python-web-app">A simple Python web app</h2>
<p>In this walkthrough we are going to stand up a simple Python web app.  The app uses Python Flask as a web server.  Flask may be new to you, but see if you see any similarities to Spring Boot.</p>
<h3 id="setup-1">Setup</h3>
<p>Clone this repo <a href="https://gitlab.com/LaunchCodeTraining/docker-flask-walkthrough" target="_blank">docker-flask-walkthrough</a></p>
<p>Install dependencies using pip by running:</p>
<pre><code>$ pip install --user -r requirements.txt</code></pre>
<p>Review file <code>simple_app.py</code></p>
<pre><code>import time

from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World!'

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)</code></pre>
<p>Run the simple web app by running the below command</p>
<pre><code class="language-nohighlight">$ python simple_app.py</code></pre>
<p>Navigate to <code>http://localhost:5000</code>, it should show our simple message.  Please <strong>stop</strong> this process as we will next get this running via a Docker container.</p>
<h3 id="create-dockerfile">Create Dockerfile</h3>
<p>We need to create a <code>Dockerfile</code> for CentOS. Add the below content into <code>/docker-flask-walkthrough/Dockerfile</code>. Don't just copy and paste it, review each line.</p>
<p><code>Dockerfile</code></p>
<pre><code># start with the centos 7 base image
FROM centos:7 

# ADD &lt;source&gt; &lt;destination&gt;, Adds the current directory to /code in the container
ADD . /code

# install and upgrade software we need on the container
RUN yum -y install epel-release
RUN yum -y update
RUN yum -y install python-pip
RUN pip install --upgrade pip
RUN pip install -r /code/requirements.txt

# Run the web app as the main process (there can only be one CMD per Dockerfile)
CMD ["python", "/code/simple_app.py"]</code></pre>
<p>We need to build a Docker image that will run our simple web app. Run the below commands in the root of <code>/docker-flask-walkthrough</code></p>
<pre><code>$ docker build --tag my-centos-simple .
$ docker create -i -t -p 5000:5000 my-centos-simple
$ docker start &lt;container_name/id&gt;</code></pre>
<p>Check the browser to see if the &quot;Hello World&quot; message shows up. <code>http://localhost:5000</code></p>
<h3 id="a-more-complex-python-app">A more complex Python app</h3>
<p>In the next section of the walkthrough, we are going to stand up a more complex Flask app.  In this app, we are going to integrate the key-value database Redis.  In order to integrate Redis into the Flask web app, we will need to leverage Docker's network capabilities.</p>
<p>Review <code>counter_app.py</code>:</p>
<pre><code>import time

import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)

def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)

@app.route('/counter')
def hello():
    count = get_hit_count()
    return 'Hello World! I have been seen {} times.\n'.format(count)

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)</code></pre>
<p>The code uses a Redis database to keep track of the number of visits to a particular page. Let's try and run to see the app in action:</p>
<pre><code>$ python counter_app.py</code></pre>
<p>If you hit the web page <code>http://localhost:5000/counter</code> you should see the following error message:</p>
<pre><code>Traceback (most recent call last`):
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1997, in __call__
    return self.wsgi_app(environ, start_response)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1985, in wsgi_app
    response = self.handle_exception(e)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1540, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1982, in wsgi_app
    response = self.full_dispatch_request()
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1614, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1517, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1612, in full_dispatch_request
    rv = self.dispatch_request()
  File "/Users/mikemenne/Library/Python/2.7/lib/python/site-packages/flask/app.py", line 1598, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "/Users/mikemenne/Code/LaunchCode/Examples/GisDevops/docker-flask-walkthrough/app.py", line 25, in hello
    count = get_hit_count()
  File "/Users/mikemenne/Code/LaunchCode/Examples/GisDevops/docker-flask-walkthrough/app.py", line 18, in get_hit_count
    raise exc
ConnectionError: Error 61 connecting to redis:6379. Connection refused.</code></pre>
<p>It looks like the app is not able to connect to <code>redis:6379</code>.  Let's do a <code>telnet</code> to check if the port is open and being listened to:</p>
<pre><code>$ telnet redis 6379
redis: nodename nor servname provided, or not known</code></pre>
<p><strong>OPE</strong>... The host <code>redis</code> doesn't exist.  This can be fixed locally by changing <code>host='redis'</code> to <code>host='127.0.0.1'</code> in <code>counter_app.py</code>.</p>
<p>Then run the app again <code>$ python counter_app.py</code> and navigate to <code>http://localhost:5000/counter</code> and see &quot;Hello World!!! I have been seen 19 times.&quot;</p>
<h3 id="linking-containers">Linking Containers</h3>
<p>We don't want our users to have to install redis on their own. We need to create a container that runs redis. Then we can link the <code>redis</code> and <code>counter-app</code> containers using <code>docker-compose</code>. Sounds fun right?</p>
<h3 id="how-to-find-the-redis-image">How to Find the Redis Image</h3>
<p>Go to <a href="https://hub.docker.com/" target="_blank">Docker Hub</a> and search for <code>redis</code>. Click on the official <code>redis</code> result. Click the <strong>tags</strong> tab. We are going to reference the <code>redis:alpine</code> tag. That refers to a specfic version of redis, details are available on the docker site.</p>
<p>Pull in a copy of the <code>redis:alpine</code> image to your computer by running <code>$ docker pull redis:alpine</code></p>
<h3 id="create-counter-app-image">Create counter-app Image</h3>
<ol>
<li>Stop your local <code>redis</code> by running <code>brew services stop redis</code></li>
<li>Change the last line in the <code>Dockerfile</code> to run the <code>counter_app.py</code>. Change to this <code>CMD ["python", "/code/counter_app.py"]</code></li>
<li>Set <code>host='redis'</code> in <code>counter_app.py</code></li>
<li>Build the <code>centos-counter-app</code> image: <code>$ docker build --tag centos-counter-app .</code>
<ul>
<li>The above command takes a while to run. After it completes you will see the below message:
<pre><code class="language-noghighlight">Successfully built 8447bcee9c62
Successfully tagged centos-counter-app:latest</code></pre></li>
</ul></li>
<li>Verify it was built by viewing images <code>$ docker images</code></li>
</ol>
<h3 id="docker-compose-file">Docker Compose File</h3>
<p>We are going to bring this all together by creating  a <code>docker-compose.yml</code> file, that will allow the Flask app to reference the Redis container.</p>
<pre><code>version: '3'
services:
  web:
    image: "centos-counter-app"
    ports:
     - "5000:5000"
  redis:
    image: "redis:alpine"</code></pre>
<p>Use the following command2 to stand up and verify the two containers:</p>
<ol>
<li>Input the above YAML into <code>docker-compose.yml</code></li>
<li>Run <code>$ docker-compose up -d</code>
<pre><code>Creating docker-flask-walkthrough_redis_1 ... done
Creating docker-flask-walkthrough_web_1   ... done</code></pre></li>
<li>Verify that the containers are running <code>$ docker ps</code></li>
<li>Naviage to <code>http://localhost:5000/counter</code></li>
</ol>
<p>Remember that your local Redis is no longer running. There is a web app conatiner running that has a connection to the redis container.</p>
<h3 id="docker-logs">Docker Logs</h3>
<p>Let's look at these containers a bit more indepth.  <code>docker logs {container name}</code> will show all of the logs that have been written to STDOUT. (replace {container name} with the actual container name).</p>
<pre><code>$ docker logs {container name/id}</code></pre>
<p>Let's also take the container details.  <code>docker inspect {container name/id}</code> will show all of the details about the container including network information.</p>
<pre><code>$ docker inspect {container name/id}</code></pre>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
