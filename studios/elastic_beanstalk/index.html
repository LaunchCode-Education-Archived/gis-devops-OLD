<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Scaling Horizontally AutoScaling Group :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-scaling-horizontally-autoscaling-group'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>Scaling Horizontally AutoScaling Group</h1>
                    <p>The ability to scale horizontally is very important in building Cloud Native applications.  In this studio, you will be extending your <a href="https://gitlab.com/LaunchCodeTraining/airwaze-studio" target="_blank">Airwaze App</a> to scale horizontally as traffic on the server increases.</p>
<h2 id="setup">Setup</h2>
<p>For this studio, you should use the VPC that you built in the <a href="../../studio/AWS2">Load Balanced Cloud Studio</a>. </p>
<p>We will be using the AWS CLI tool for some parts of the studio.  The AWS CLI tool allows you to create and change infrastructure on the cloud via the command line.  </p>
<p>To install the AWS CLI tool run the following commands. (You may need to add permissions to install awscli.)</p>
<pre><code class="language-nohighlight">$ brew install awscli
$ echo 'complete -C aws_completer aws' &gt;&gt; ~/.bashrc
$ aws --version</code></pre>
<p>Next configure the AWS CLI tool with your credentials.  These credentials can be found in <em>IAM &gt; Users &gt; You.</em> Click &quot;Create Access Key&quot;.
<img src="../../materials/week05/day3/iam_get_credentials.png" alt="Screenshot of IAM credentails" /></p>
<aside class="aside-note">
<p>It is very important that you keep the AWS Secret Access Key private.  Access to that key allows anyone to programmatically spin up infrastructure on the AWS account. </p>
</aside>
<p>Next configure your the AWS CLI tool.  Use the &quot;Default region name&quot; or <code>us-east-2</code>:</p>
<pre><code class="language-nohighlight">$ aws configure
AWS Access Key ID [None]: AK-------------------
AWS Secret Access Key [None]: r4------------------
Default region name [None]: us-east-2
Default output format [None]: </code></pre>
<p>For example, you should now be able to list all of the buckets in S3:</p>
<pre><code class="language-nohighlight">$ aws s3 ls</code></pre>
<h3 id="configure-buckets">Configure Buckets</h3>
<p>Since we are going to be horizontally scaling, we need machines to spin up automatically without any human interaction.  We are going to upload the executable jar file to S3 so that machines can pull down the file when they automatically spin up.</p>
<p>First create a new bucket in S3.  Remember <strong>EVERY</strong> bucket in S3 in the whole wide world has to be unique.  Use the pattern below to get a unique name.</p>
<pre><code class="language-nohighlight">$ aws s3 mb s3://launchcode-gisdevops-c1-yourname/</code></pre>
<p>Run <code>aws s3 ls</code> to make sure that the bucket was created properly.</p>
<p>Go ahead and build a new executable jar file using the Gradle <code>bootRepackage</code> command.  When it is finished building, rename the file to <code>app.jar</code> and upload the jar to S3 using the following command:</p>
<pre><code class="language-nohighlight">$ aws s3 cp ~/airwaze-studio/build/libs/app.jar s3://launchcode-gisdevops-c1-yourname/ # your filepath may be different
$ aws s3 ls s3://launchcode-gisdevops-c1-yourname/ # check to make sure it uploaded</code></pre>
<p>When we run our initialization script later, the script will pull down the <code>app.jar</code> file with this command:</p>
<pre><code class="language-nohighlight">$ aws s3 sync s3://launchcode-gisdevops-c1-yourname/ /opt/airwaze</code></pre>
<h3 id="configure-your-vpc">Configure your VPC</h3>
<p>Next we want to configure the VPC to contain an autoscaling group. Navigate to EC2 and click on &quot;Auto Scaling Group&quot; in the left sidebar. Click &quot;Create Auto Scaling Group.&quot;
<img src="../../materials/week05/day3/autoscaling_group.png" alt="Screenshot of autoscaling group" /></p>
<p>Click &quot;Create a new launch configuration&quot;</p>
<p>Select the custom AMI that we created in the last studio.  It should be located in the &quot;My AMIs&quot; section.</p>
<p>Name the LaunchConfiguration <code>launchConfig-yourname</code>.  Give it the IAM role of <code>EC2_to_S3_readonly</code>.  In advanced details, paste in the following script:</p>
<pre><code class="language-nohighlight">#!/bin/bash
# Install Java
apt-get update -y &amp;&amp; apt-get install -y openjdk-8-jdk awscli

# Create airwaze user
useradd -M airwaze
mkdir /opt/airwaze
aws s3 sync  s3://launchcode-gisdevops-c1-yourname/ /opt/airwaze
mkdir /etc/opt/airwaze
chown -R airwaze:airwaze /opt/airwaze /etc/opt/airwaze
chmod 777 /opt/airwaze

# Write Airwaze config file
cat &lt;&lt; EOF &gt; /etc/opt/airwaze/airwaze.config
APP_DB_HOST=rds-instance.us-east-2.rds.amazonaws.com
APP_DB_PORT=5432
APP_DB_NAME=airwaze_db
APP_DB_USER=airwaze_user
APP_DB_PASS=verysecurepassword
EOF

# Write systemd unit file
cat &lt;&lt; EOF &gt; /etc/systemd/system/airwaze.service
[Unit]
Description=Airwaze Studio
After=syslog.target

[Service]
User=airwaze
EnvironmentFile=/etc/opt/airwaze/airwaze.config
ExecStart=/usr/bin/java -jar /opt/airwaze/app.jar SuccessExitStatus=143
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable airwaze.service</code></pre>
<p>Click &quot;Assign a public IP address to every instance.&quot;</p>
<p>Add general storage.  </p>
<p>For the security group, you want to add the Security Group of your web servers in your VPC.  Both 22 and 80 should be kept open.</p>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
