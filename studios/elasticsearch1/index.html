<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Elasticsearch Query Studio :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-elasticsearch-query-studio'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>Elasticsearch Query Studio</h1>
                    <h2 id="es-installation">ES Installation</h2>
<p>We need to install Elasticsearch locally. Remember, ES is built on Lucene, a Java library. So you may be prompted to install a particular version of Java that is a dependency of the current version of ES.</p>
<p>On Mac, use Homebrew:</p>
<pre><code class="language-nohighlight">$ brew install elasticsearch</code></pre>
<p>And then, to start up the server:</p>
<pre><code class="language-nohighlight">$ brew services start elasticsearch</code></pre>
<p>Let’s check if our installation was successful by checking the cluster’s health:</p>
<pre><code class="language-nohighlight">$ curl -XGET 'localhost:9200/_cat/health?v&amp;pretty'</code></pre>
<p>All being well, the output should look something like this:</p>
<pre><code class="language-nohighlight">epoch      timestamp cluster              status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
1516231703 17:28:23  elasticsearch_cheryl yellow          1         1      5   5    0    0        5             0                  -                 50.0%</code></pre>
<aside class="aside-note">
<p>If you don't receive something like the response above, restart the service using: <code>brew services restart elasticsearch</code>.</p>
</aside>
<p>Cluster health is expressed as the color green, yellow, or red.</p>
<ul>
<li>Green - everything is good (cluster is fully functional)</li>
<li>Yellow - all data is available but some replicas are not yet allocated (cluster is fully functional, but more vulnerable to data loss/corruption)</li>
<li>Red - some data is not available for whatever reason (cluster is partially functional)</li>
</ul>
<aside class="aside-note">
<p>When a cluster is red, it will continue to serve search requests from the available shards but you will likely need to fix it ASAP since there are unassigned shards.</p>
</aside>
<p>You can see from the output that we have 1 node and 0 shards (since there’s no data yet).
Let’s confirm we don’t have any indices/index yet.</p>
<pre><code class="language-nohighlight">$ curl -XGET 'localhost:9200/_cat/indices?v&amp;pretty'</code></pre>
<p>Your response should just show headers and no content:</p>
<pre><code class="language-nohighlight">health status index                                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size</code></pre>
<h2 id="data-storage">Data Storage</h2>
<p>Let’s create an index:</p>
<pre><code class="language-nohighlight">$ curl -XPUT 'localhost:9200/book?pretty'</code></pre>
<p>Now if you check for indices, you will have data:</p>
<pre><code class="language-nohighlight">$ curl -XGET 'localhost:9200/_cat/indices?v&amp;pretty'</code></pre>
<pre><code class="language-nohighlight">health status index                                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   book                                     cNIKN2CyQsacysajAuJH1A   5   1          0            0       466b           466b</code></pre>
<aside class="aside-note">
<p>Don’t be concerned that your clusters or indices have yellow health in these tutorials. ES by default creates one replica for your index, but there is no second node in the cluster to assign the replica to. It is not possible to have green health without having at least one more server assigned to this cluster.</p>
</aside>
<p>Now that we have an index to store documents in, let’s add a document:</p>
<pre><code class="language-nohighlight">$ curl -XPUT 'localhost:9200/book/doc/1?pretty' -H 'Content-Type: application/json' -d' { "title": "Frankenstein" }'</code></pre>
<p>Output should tell you if the command was successful:</p>
<pre><code class="language-json">{
  "_index" : "book",
  "_type" : "doc",
  "_id" : "1",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}</code></pre>
<p>It also applies an internal ID of 1. In many cases, Elasticsearch is used like a replica database where the primary is PostgreSQL or MySQL. In this case, the convention is to allow your <code>_id</code> values to be completely independent from the ID from the primary store, which is then stored like a foreign key. Remember, your cluster may be distributed among many servers, so Elasticsearch will try to use a unique hash ID that is unlikely to have collisions if a race condition between servers were to happen. You can allow ES to assign the ID by leaving it off the command.</p>
<p>Let’s edit our existing record. Imagine our book came from MySQL; we might add a another field like this:</p>
<pre><code class="language-nohighlight">$ curl -XPUT 'localhost:9200/book/doc/1?pretty' -H 'Content-Type: application/json' -d'
  {
    "title": "Frankenstein",
    "book_id": "7",
    "author_name": "Mary Shelley"
  }'</code></pre>
<p>You can delete documents or indices with <code>-XDELETE</code>:</p>
<pre><code class="language-nohighlight">$ curl -XDELETE 'localhost:9200/book?pretty'</code></pre>
<p>If you look at the commands we have used so far, you’ll notice they’re all constructed in the same way using REST verbs. Do you see each piece of the commands? Identify to yourself the REST verb, Index name/url, ES <code>_id</code>, and JSON Content in each of our previous commands.</p>
<p>Go ahead and recreate our book index. (Try to remember how to type out the command before you look it up.)</p>
<h2 id="lets-play">Let’s Play</h2>
<p>Let’s put that book back in, with a couple others. This time allow ES to assign the <code>_id</code>.</p>
<pre><code class="language-nohighlight">$ curl -XPOST 'localhost:9200/book/doc?pretty' -H 'Content-Type: application/json' -d'
  {
    "title": "Frankenstein",
    "book_id": "7",
    "author_name": "Mary Shelley"
  }'</code></pre>
<pre><code class="language-nohighlight">$ curl -XPOST 'localhost:9200/book/doc?pretty' -H 'Content-Type: application/json' -d'
  {
    "title": "The Romance of the Forest",
    "book_id": "11",
    "author_name": "Ann Radcliffe"
  }'</code></pre>
<pre><code class="language-nohighlight">$ curl -XPOST 'localhost:9200/book/doc?pretty' -H 'Content-Type: application/json' -d'
  {
    "title": "Persuasion",
    "book_id": "17",
    "author_name": "Jane Austen"
  }'</code></pre>
<pre><code class="language-nohighlight">$ curl -XPOST 'localhost:9200/book/doc?pretty' -H 'Content-Type: application/json' -d'
  {
    "title": "Middlemarch",
    "book_id": "25",
    "author_name": "George Eliot"
  }'</code></pre>
<p>Add your favorite book too--just make up a <code>book_id</code> that is an integer that is different from the value of other other books' <code>book_id</code>.</p>
<p>Just in case you weren’t sure what data was in your index, let’s see if we can get the data back out. Try:</p>
<pre><code class="language-nohighlight">$ curl -XGET 'localhost:9200/book/_search?pretty' -H 'Content-Type: application/json' -d'
{
  "query": { "match_all": {} },
  "from": 1,
  "size": 10
}
'</code></pre>
<p>Take a minute to read over the output. There is some general information about the query’s run at the top, then the resulting documents at the bottom.</p>
<p>Let’s try to update &quot;Middlemarch.&quot; <strong>Update the id-hash to use whatever showed for your local <code>_id</code>.</strong></p>
<pre><code class="language-nohighlight">$ curl -XPUT 'localhost:9200/book/doc/seXDBmEBSegcuMJ-3las?pretty' -H 'Content-Type: application/json' -d'
{
  "title": "Middlemarch",
  "book_id": "25",
  "author_name": "Mary Ann Evans"
}
'</code></pre>
<p>You should see output telling you it was successful, but just in case let’s search for that document with a <code>"match"</code> query and see what it says.</p>
<pre><code class="language-nohighlight">$ curl -XGET 'localhost:9200/book/_search?pretty' -H 'Content-Type: application/json' -d'
{
  "query": { "match": { "title": "Middlemarch" } }
}
'</code></pre>
<p>Your results should look similar to this:</p>
<pre><code class="language-json">{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : 1,
    "max_score" : 0.2876821,
    "hits" : [
      {
        "_index" : "book",
        "_type" : "doc",
        "_id" : "seXDBmEBSegcuMJ-3las",
        "_score" : 0.2876821,
        "_source" : {
          "author_name" : "Mary Ann Evans",
          "title" : "Middlemarch",
          "book_id" : "25"
        }
      }
    ]
  }
}</code></pre>
<p>What other questions could you answer with this data? Practice writing some queries looking up books by <code>book_id</code>, by author, etc. See if you can figure out how to look up a book with a partial match (i.e. searching for <code>Romance</code> would return &quot;The Romance of the Forest&quot; and &quot;Half a Lifelong Romance&quot; by &quot;Eileen Chang&quot;).</p>
<p>If you could add a field or two, what new questions could you answer? Go ahead and play with the data and test out your queries.</p>
<p>Want to try building another index? Check out the <a href="https://github.com/awesomedata/awesome-public-datasets" target="_blank">awesome public datasets project</a> on GitHub.</p>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
