<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Scaling horizontally AutoScaling Group :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-scaling-horizontally-autoscaling-group'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>Scaling horizontally AutoScaling Group</h1>
                    <p>The ability to scale horizontally is very important in building Cloud Native applications.  In this studio, you will be extending your <a href="https://gitlab.com/LaunchCodeTraining/airwaze-studio" target="_blank">Airwaze App</a> to scale horizontally as traffic on the server increases.</p>
<h2 id="setup">Setup</h2>
<p>FIRST, change your project to run on port 80.  Add this line to your <code>applications.properties</code> file:</p>
<pre><code>server.port=80</code></pre>
<aside class="aside-note">
  Note!  You will be working in the "Northern Virginia region.
</aside>
<h3 id="aws-cli">AWS CLI</h3>
<p>We will be using the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" target="_blank">AWS CLI tool</a> for some parts of the studio.  The AWS CLI tool allows you to create and change infrastructure on the cloud via the command line.  </p>
<p>To install the AWS CLI tool run the following commands:</p>
<pre><code>$ brew install awscli
$ echo 'complete -C aws_completer aws' &gt;&gt; ~/.bashrc
$ aws --version</code></pre>
<p>Next configure the AWS CLI tool with your credentials.  These credentials can be found in IAM &gt; Users &gt; You. Click &quot;Create Access Key&quot;.
<img src="../../materials/week05/day3/iam_get_credentials.png" alt="Screenshot of IAM credentails" /></p>
<aside class="aside-note">
  It is very important that you keep the `AWS Secret Access Key` private.  Access to that key allows anyone to programmatically spin up infrastructure on the AWS account. 
</aside>
<p>Next configure your the AWS CLI tool.  Use the &quot;Default region name&quot; or <code>us-east-1</code>:</p>
<pre><code>$ aws configure
AWS Access Key ID [None]: AK-------------------
AWS Secret Access Key [None]: r4------------------
Default region name [None]: us-east-1
Default output format [None]: </code></pre>
<p>You should now be able to run commands against AWS.  For example, you should now be able to list all of the buckets in S3:</p>
<pre><code>$ aws s3 ls</code></pre>
<p>Take a look around by looking at the help pages for a couple of commands:</p>
<pre><code>$ aws help
$ aws s3 help
$ aws s3 sync help</code></pre>
<p>The <code>aws help</code> command is a quick alternative to looking up information about the tool on line.</p>
<h3 id="create-a-keypair-for-the-region">Create a KeyPair for the Region</h3>
<p>Since you are in a new Region, you will need to create a new KeyPair.</p>
<ol>
<li>Make sure you are in region <code>U.S. East (N.Virginia)</code></li>
<li>Go to EC2 in the services menu</li>
<li>Click <strong>Key Pairs</strong> in the left menu in the <strong>NETWORK &amp; SECURITY</strong> section</li>
<li>Enter a name like <code>yourname-useast-key</code></li>
<li>Download key</li>
<li>Copy the key to your <code>~/.ssh</code> folder</li>
<li>Make it so that only the owner can read and write to the file <code>$chmod 400 yourname-useast-key.pem</code></li>
</ol>
<h2 id="configure-your-vpc-via-cloudformation">Configure your VPC via CloudFormation</h2>
<p>You are going to use <a href="https://aws.amazon.com/cloudformation/" target="_blank">Amazon CloudFormation</a> to spin up your VPC.  CloudFormation can create infrastructure on AWS based on a JSON template.  CloudFormation allows you to create consistent, reproducible AWS environments.</p>
<p>You'll be using a CloudFormation template that adds 4 Subnets, 3 Security Groups, and 1 RDS.  AWS CloudFormation will pull the template from S3.</p>
<h3 id="review-the-cloudformation-script">Review the CloudFormation Script</h3>
<p>Take a look at the template by downloading it with the <code>aws-cli</code> tool. Then open <code>airwaze_cloudformation.json</code> in your favorite editor. You should recognize the names and properties listed from previous studios, the only new thing is seeing them in this format.</p>
<pre><code>$ mkdir ~/s3-sync
$ aws s3 sync s3://launchcode-gisdevops-cloudformation ~/s3-sync</code></pre>
<h3 id="using-the-cloudformation-script">Using the CloudFormation Script</h3>
<p>To run CloudFormation, navigate to the CloudFormation page via the search bar.  Click &quot;Create Stack&quot;.</p>
<p>Now we tell CloudFormation what JSON template to use when building the infrastructure.  We're going to give it the URL of the JSON template that we looked at with the <code>aws s3 sync ...</code> command.</p>
<ul>
<li>Choose &quot;Specify an Amazon S3 template URL&quot; and paste in <a href="https://s3.amazonaws.com/launchcode-gisdevops-cloudformation/airwaze_cloudformation.json" target="_blank">https://s3.amazonaws.com/launchcode-gisdevops-cloudformation/airwaze_cloudformation.json</a>. </li>
<li>Click &quot;Next&quot; when you are done. </li>
</ul>
<p><img src="../../materials/week05/day3/stack_screen_1.png" alt="Screenshot of CF Screen 1" /></p>
<p>Next we need to give your stack a name and pass along a few parameters to customize the VPC.</p>
<ul>
<li>Fill in Stack Name with &quot;airwaze-{your name}&quot;.</li>
<li>Fill in DatabasePassword with &quot;verysecurepassword&quot;.</li>
<li>Fill in KeyName with with the name of your access key for this region. (use the one you created above)</li>
</ul>
<p><img src="../../materials/week05/day3/stack-parameters2.png" alt="Screenshot of Stack parameters" /></p>
<ul>
<li>Click Next on the &quot;Options Screen&quot;</li>
<li>Click Create on the &quot;Review Screen&quot;</li>
</ul>
<p>It will take CloudFormations about 15 minutes to spin up your VPC.  The &quot;Events&quot; tab will give you continuous updates on the progress of the job.</p>
<h3 id="configure-buckets">Configure Buckets</h3>
<p>Since you will be scaling machines horizontally, you won't be able to <code>scp</code> a jar to each machine.  Instead, the machines will reach out and grab a copy of the jar when they spin up.  The servers will download a copy of the application from S3.</p>
<p>First create a new bucket in S3.  Remember <strong>EVERY</strong> bucket in S3 in the whole wide world has to be unique.  Use the pattern below to get a unique name.</p>
<pre><code>$ aws s3 mb s3://launchcode-gisdevops-c1-yourname/</code></pre>
<p>Run <code>aws s3 ls</code> to make sure that the bucket was created properly.</p>
<p>Go ahead and build a new executable jar file using the Gradle <code>bootRepackage</code> command.  When it is finished building rename the file to <code>app.jar</code> and upload the jar to S3 using the following command:</p>
<pre><code>$ aws s3 cp build/libs/app.jar s3://launchcode-gisdevops-c1-yourname/ 
$ aws s3 ls s3://launchcode-gisdevops-c1-yourname/ # check to make sure it uploaded</code></pre>
<p>When we run our initialization script later, the script will pull down the <code>app.jar</code> file with this command:</p>
<pre><code>$ aws s3 sync s3://launchcode-gisdevops-c1-yourname/ /opt/airwaze</code></pre>
<p>You should also check out S3 in the console:
<a href="https://s3.console.aws.amazon.com/s3/home?region=us-east-1" target="_blank">https://s3.console.aws.amazon.com/s3/home?region=us-east-1</a></p>
<h3 id="configure-the-database">Configure the database</h3>
<p>You'll also need to do some initial database setup.</p>
<ul>
<li>Create an EC2 instance in the <code>SubnetWebAppPublic</code> subnet.</li>
<li>Once it is up, SSH into the server and run the following commands:</li>
</ul>
<pre><code>$ sudo apt-get update
$ sudo apt-get install postgresql
$ psql -h airwaze-example.cew68jaqkoek.us-east-1.rds.amazonaws.com -p 5432 -U masterUser airwaze
CREATE USER airwaze_user WITH PASSWORD 'verysecurepassword';
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;
CREATE EXTENSION fuzzystrmatch;
CREATE EXTENSION postgis_tiger_geocoder;
CREATE TABLE airport
(
id serial primary key,
airport_id integer,
airport_lat_long geometry,
altitude integer,
city character varying(255),
country character varying(255),
faa_code character varying(255),
icao character varying(255),
name character varying(255),
time_zone character varying(255)
);
CREATE TABLE route
(
id serial primary key,
airline character varying(255),
airline_id integer,
dst character varying(255),
dst_id integer,
route_geom geometry,
src character varying(255),
src_id integer
);
ALTER TABLE airport OWNER to airwaze_user;
ALTER TABLE route OWNER to airwaze_user;</code></pre>
<p>Also, send up the <code>routes.csv</code> file and the <code>Airports.csv</code> file and get those in the database. </p>
<pre><code>$ scp -i ~/.ssh/mikes-keys.pem routes.csv  ubuntu@35.170.78.180:/home/ubuntu
$ scp -i ~/.ssh/mikes-keys.pem Airports.csv  ubuntu@35.170.78.180:/home/ubuntu
$ psql -h airwaze-example.cew68jaqkoek.us-east-1.rds.amazonaws.com -d airwaze -U airwaze_user -c "\copy route(src, src_id, dst, dst_id, airline, route_geom) from STDIN DELIMITER ',' CSV HEADER" &lt; /home/ubuntu/routes.csv
$ psql -h airwaze-example.cew68jaqkoek.us-east-1.rds.amazonaws.com -d airwaze -U airwaze_user -c "\copy airport(airport_id, name, city, country, faa_code, icao, altitude, time_zone, airport_lat_long) from STDIN DELIMITER ',' CSV HEADER" &lt; /home/ubuntu/Airports.csv</code></pre>
<h2 id="create-the-launch-configuration">Create the Launch Configuration</h2>
<p>You now have all of the pieces set up to begin Auto Scaling EC2 machines.</p>
<p>Navigate to <a href="https://console.aws.amazon.com/ec2/autoscaling/home" target="_blank">AutoScaling Page</a> on the sidebar of EC2.  Click &quot;Create Auto Scaling Group&quot;.</p>
<p><img src="../../materials/week05/day3/create_auto_scaling_group.png" alt="Screenshot of AutoScale Start" /> </p>
<p>A LaunchConfiguration is essentially creating a template for all of the EC2 instances that will be spun up automatically via Auto Scale.</p>
<ul>
<li>You are going to create a new Launch Configuration.</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_step_1.png" alt="Screenshot of AutoScale Step 1" /></p>
<p>The Launch Configuration is going to be very similar to setting up a normal EC2 instance.  </p>
<ul>
<li>Choose the Ubuntu distribution on the AMI screen.</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_ami.png" alt="Screenshot of Auto Scale AMI" /></p>
<ul>
<li>Choose the micro instance.</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_instance_size.png" alt="Screenshot of Auto Scale instance size" /></p>
<p>There are several important configurations that have to be made on the &quot;Configure Details&quot; screen.</p>
<p>The moist important is the User data.  The &quot;User data&quot; is the script that runs as the server starts up.  This script creates the proper directories, configures systemd, and launches the app. Additionally, the app pulls down a copy of the jar file from S3. </p>
<p>There are two pieces of data to change in the &quot;User data&quot; script: </p>
<p>1) Set <code>APP_DB_HOST</code> to the endpoint of your RDS database. </p>
<p>2) Change the <code>aws s3 c s3://launchcode-gisdevops-c1-yourbucket/app.jar /opt/airwaze/app.jar</code> command to point to the bucket that you created earlier in the studio.</p>
<ul>
<li>
<p>Paste your updated script in the &quot;User data&quot; field.</p>
</li>
<li>
<p>Set &quot;IAM role&quot; to &quot;EC2_to_S3_readonly&quot;. When the machine is spinning up, the startup script will need to reach out to S3.  The &quot;IAM role&quot; gives the startup script the proper credentials to be authenticated to access S3.</p>
</li>
<li>
<p>Set the name of the configuration to <code>airwaze-{your name}-config</code>.</p>
</li>
<li>Change the &quot;IP Address Type&quot; to be <code>Assign a public IP address to every instance</code>.</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_config.png" alt="Screenshot of Auto Scale configuration" /></p>
<ul>
<li>
<p>Click &quot;Next: Configure Security Group&quot;</p>
</li>
<li>
<p>On the Security Group screen, choose the <code>WebAppSecurityGroup</code> from your VPC.  The key is that you want to have ports 22 and 80 open on the machines that you are running.</p>
</li>
<li>
<p>Click &quot;Review&quot;</p>
</li>
<li>Click &quot;Create Launch configuration&quot;</li>
</ul>
<pre><code>#!/bin/bash
# Install Java
apt-get update -y &amp;&amp; apt-get install -y openjdk-8-jdk awscli

# Create airwaze user
useradd -M airwaze
mkdir /opt/airwaze
mkdir /etc/opt/airwaze
aws s3 cp s3://launchcode-gisdevops-c1-traineemike/app.jar /opt/airwaze/app.jar 
chown -R airwaze:airwaze /opt/airwaze /etc/opt/airwaze
chmod 777 /opt/airwaze

# Write Airwaze config file
cat &lt;&lt; EOF &gt; /etc/opt/airwaze/airwaze.config
APP_DB_HOST=airwaze-example.cew68jaqkoek.us-east-1.rds.amazonaws.com
APP_DB_PORT=5432
APP_DB_NAME=airwaze
APP_DB_USER=airwaze_user
APP_DB_PASS=verysecurepassword
EOF

# Write systemd unit file
cat &lt;&lt; EOF &gt; /etc/systemd/system/airwaze.service
[Unit]
Description=Airwaze Studio
After=syslog.target

[Service]
User=airwaze
EnvironmentFile=/etc/opt/airwaze/airwaze.config
ExecStart=/usr/bin/java -jar /opt/airwaze/app.jar SuccessExitStatus=143
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable airwaze.service</code></pre>
<p><img src="../../materials/week05/day3/auto_scale_security_groups.png" alt="Screenshot of Auto Scale security groups" /></p>
<h2 id="create-the-auto-scale-group">Create the Auto Scale Group</h2>
<p>The Auto Scale Group is the piece of configuration responsible for how and when new machines are spun up (and spun down).</p>
<p>The first step is configuring where the machines will be spun up.</p>
<ul>
<li>
<p>For &quot;Group name&quot;, provide a name similiar to <code>airwaze-{your name}</code> (replace {your name} of course...)</p>
</li>
<li>
<p>For &quot;Network&quot;, choose your VPC.</p>
</li>
<li>
<p>For &quot;Subnet&quot;, choose the <code>SubnetWebAppPublic</code>.</p>
</li>
<li>Click &quot;Next: Configure Scaling Policy&quot;</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_group_1.png" alt="Screenshot of Auto Scale configuration" /></p>
<p>The next screen configures how an app scales up.</p>
<ul>
<li>
<p>Select <code>Use scaling policies to adjust the capacity of this group</code>.</p>
</li>
<li>
<p>Mark that the app can scale up to 5 machines.</p>
</li>
<li>
<p>Change the name to <code>Scale Fast!</code>.</p>
</li>
<li>
<p>Set the &quot;Target value&quot; to 5.  &quot;Target value&quot; is the percentage of CPU that triggers another machine to be provisioned.</p>
</li>
<li>
<p>Set the &quot;Instances need&quot; to 40 seconds.  Since Spring Boot packages the web server in the jar, your application doesn't need as much spin up time as other machines.</p>
</li>
<li>Click &quot;Next: Configure Notifications&quot;</li>
</ul>
<p><img src="../../materials/week05/day3/auto_scale_group_config.png" alt="Screenshot of Auto Scale configuration" /></p>
<ul>
<li>
<p>Click &quot;Next: Configure Tags&quot;</p>
</li>
<li>
<p>Click &quot;Review&quot;</p>
</li>
<li>Click &quot;Create Auto Scaling Group&quot;</li>
</ul>
<p>This will create you Auto Scaling Group.  At first, the summary page will say 0 instances; it typically takes a couple of minutes to initialize.</p>
<p><img src="../../materials/week05/day3/auto_scaling_group_dash.png" alt="Screenshot of Auto Scaling Group Dash" /></p>
<p>The &quot;Instances&quot; tab will show you how many machines you currently have running in your Auto Scaling Group.</p>
<p><img src="../../materials/week05/day3/auto_scaling_instances_tab.png" alt="Screenshot of the Instances tab" /></p>
<p>Next you need to hook a load balancer up to your Auto Scaling Group.  We'll need to configure the Target Groups of the Elastic Load Balancer.</p>
<ul>
<li>
<p>Navigate to the <a href="https://console.aws.amazon.com/ec2/v2/home?&amp;region=us-east-1#TargetGroups:sort=targetGroupName" target="_blank">Target Groups Page</a> and select the Target Group in your VPC.</p>
</li>
<li>Click &quot;Edit&quot;</li>
</ul>
<p><img src="../../materials/week05/day3/target_groups_click_edit.png" alt="Screenshot of Target Groups Edit" /></p>
<ul>
<li>Select <code>WebAppTargets</code> from the &quot;Target Groups&quot; drop down.</li>
</ul>
<p><img src="../../materials/week05/day3/target_groups_set_target.png" alt="Screenshot of Target Groups select target" /></p>
<h2 id="placing-load-on-your-app">Placing Load on your App</h2>
<p>Next, you want to test that your autoscaling is working properly.  </p>
<p>You are going to be using a Node library called <a href="https://www.npmjs.com/package/loadtest" target="_blank">loadtest</a>.<br />
<a href="https://www.npmjs.com/package/loadtest" target="_blank">loadtest</a> measures the average latency time of a concurrent requests to a server.  </p>
<aside class="aside-note">
  Note: Tools like loadtest and Apache AB are like guns.  You don't point them live things unless you want to kill it.  It's fine to point a load test tool at your non production apps on AWS; in fact you need to make sure that it can handle load.  You would never want to point a load testing tool at a live site because:
  * It's your live site (your staging environment should be similar enough to production to replicate the error).
  * Your production site will be sitting behind one or more layers like a CDN.  Your load test is going to look a lot like a denial of service attack. Services like your CDN are designed to recognize and block attacks at the fringe of your network.  Running a load test against a live site is a good way to get your IP address blocked.
</aside>
<p>To install <a href="https://www.npmjs.com/package/loadtest" target="_blank">loadtest</a> install the following npm package globally (<code>-g</code>)</p>
<pre><code>$ sudo npm install -g loadtest</code></pre>
<p>Next, you can run a command to put load on the server. The following command runs 200 requests per second sending 10 concurrent results to the server at a time. </p>
<pre><code>loadtest -c 10 --rps 200 http://internal-airwa-WebAp-1CT34V4AX36U0-774969334.us-east-1.elb.amazonaws.com </code></pre>
<p>How many auto scaling servers does it take to accomodate a load of 200 requests per second?</p>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
