<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Studio: Load Balanced Cloud :: GIS DevOps</title>

        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/highlight.launchcode.css">
        <link rel="stylesheet" href="https://education.launchcode.org/gis-devops/css/main.css">
        <link rel="stylesheet" href="https://djwbyvgln9kts.cloudfront.net/launch_ed_style/custom.css">
    </head>
    <body id='page-studio-load-balanced-cloud'>

        <header class="navbar navbar-default navbar-fixed-top">

            <ul class="nav navbar-nav">

                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle glyphicon glyphicon-menu-hamburger" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                        <ul class="dropdown-menu">
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/objectives/">
                                        Objectives
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/resources/">
                                        Resources
                                    </a>
                                </li>
                                                            <li class=" lc-button">
                                    <a href="https://education.launchcode.org/gis-devops/about/">
                                        About This Course
                                    </a>
                                </li>
                                                        <li role="separator" class="divider"></li>
                            <li>
                                <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch">Search This Site</a>
                            </li>
                        </ul>
                    </li>

                
            </ul>

            <div>
                <a class="navbar-brand site-title navbar-center" href="https://education.launchcode.org/gis-devops/">
                    <h1>GIS DevOps</h1>
                </a>
            </div>

            <div class="nav navbar-nav navbar-right">
                <a class="navbar-brand dabomb" href="https://education.launchcode.org/gis-devops/"></a>
            </div>

        </header>

        <!-- Search Modal -->
        <div id="modalSearch" class="modal fade" role="dialog">
           <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
                   <h4 class="modal-title">Search GIS DevOps</h4>
                </div>
                <div class="modal-body">
                    <script>
                      (function() {
                        var cx = "014657181352409571810:oq1krtyri4k";
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                      })();
                    </script>
                    <gcse:search></gcse:search>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

           </div>
        </div>

        <main class="container-fluid">
            <div class="row">

                <section id="content" class="col-sm-offset-2 col-sm-8">
                                        <h1>Studio: Load Balanced Cloud</h1>
                    <h2 id="overview">Overview</h2>
<p>This studio will expand on what was learned in the AWS basics unit. Your goal is create a load-balanced cloud-based application using good AWS Dev Ops practices.</p>
<h2 id="prepare-the-code">Prepare the Code</h2>
<ul>
<li>Start with the corrected code you finished with in the last studio.</li>
<li>Open the <code>application.properties</code> file. Find and change the following lines:
<pre><code class="language-nohighlight">spring.datasource.url=jdbc:postgresql://${APP_DB_HOST}:${APP_DB_PORT}/${APP_DB_NAME}
spring.datasource.username=${APP_DB_USER}
spring.datasource.password=${APP_DB_PASS}
spring.jpa.hibernate.ddl-auto = update</code></pre></li>
<li>Go into IntelliJ's Gradle tool window, and click on <em>Tasks &gt; build &gt; bootRepackage</em>.</li>
<li>Verify that the jar appears in <code>build/libs</code>.</li>
</ul>
<h2 id="provision-a-vpc">Provision a VPC</h2>
<p>In order to isolate your application instances from other instances in AWS, you need to create a Virtal Private Cloud (VPC). This gives you your own little private network in the cloud which can help when establishing access controls as well as keeping your instances private from the rest of AWS. Typically, you'll have a few of these in an enterprise environment to keep strict boundaries between unrelated services.</p>
<ul>
<li>Click &quot;Services&quot; in the header and locate &quot;VPC&quot; under &quot;Networking &amp; Content Delivery.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/1-vpc-in-header.png" alt="Screen shot with red arrow pointing to VPC in the Services list" /></p>
<ul>
<li>When you arrive on the VPC dashboard, click &quot;Start VPC Wizard&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/2-start-vpc-wizard.png" alt="Screen shot with red circle around the Start VPC Wizard button" /></p>
<ul>
<li>For this studio, select the simplest VPC configuration - a single public subnet. This allows your instances to connect to the internet without an intermediary.
<ul>
<li>Some VPCs will have private subnets that require a Network Address Translator (NAT) instance to serve as a gateway for private services to connect to the internet and outside services.</li>
<li>Other configurations allow (or require) a VPN connection and can serve as an extension of a private data center.</li>
</ul></li>
</ul>
<p><img src="../../materials/week05/lb-cloud/3-vpc-public-subnet.png" alt="Screen shot with red circle around the VPC with a Single Public Subnet tab" /></p>
<ul>
<li>When creating the VPC, the defaults are sufficient for your needs. Provide a useful VPC name to help identify this VPC among the others.</li>
<li>Note the IPv4 CIDR block. This defines the IP addresses that will be available in your VPC. (See <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks" target="_blank">Wikipedia's CIDR table</a>.) A <code>x.x.x.x/16</code> block will include 65,536 addresses.</li>
<li>The Public subnet's IPv4 CIDR will be <code>x.x.x.x/24</code>, which includes 256 addresses. This is the subnet where you'll put your public-facing instances (such as your Airwaze app).</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/4-create-vpc.png" alt="Screen shot of the "VPC with a Single Public Subnet" configuration window" /></p>
<ul>
<li>After creating the VPC, make sure to note the <code>VPC ID</code> of your VPC as that name will appear everywhere you will select it later.
<ul>
<li>Not every AWS web interface includes the descriptive name you gave before.</li>
</ul></li>
</ul>
<p><img src="../../materials/week05/lb-cloud/5-vpc-dashboard.png" alt="Screen shot of the VPC Dashboard with a red circle around the VPC ID" /></p>
<ul>
<li>Next, you need to create two private subnets for your RDS instance. Select &quot;Subnets&quot; in the VPC Dashboard sidebar.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/5.1-subnets.png" alt="Screen shot of the Virtual Private Cloud sidebar with a red arrow pointing to Subnets" /></p>
<ul>
<li>On the Subnet dashboard page, click the &quot;Create Subnet&quot; button.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/5.2-create-subnet.png" alt="Screen shot with a red circle around the Create Subnet button" /></p>
<ul>
<li>To create the subnet, give it a descriptive name to help identify it later.</li>
<li>Select your VPC from the VPC select list.</li>
<li>Select one of the availablity zones for your region.</li>
<li>Create a new CIDR block for this private subnet.
<ul>
<li>Remember, if you use a <code>x.x.x.x/24</code> subnet, that will contain 256 addresses, so increase the third number by one from the previously created subnet.</li>
</ul></li>
<li>Do this twice, with a different availability zone and CIDR block for both subnets.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/5.3-creating-subnet.png" alt="Screen shot of the Create Subnet configuration window" /></p>
<h2 id="set-up-rds">Set Up RDS</h2>
<p>Now that the VPC is set up and ready for use, you need to create your database server. In the last studio, you installed a PostgreSQL server on your instance. This time, you'll use AWS's Relational Database Service (RDS) to host and manage our DB instance.</p>
<ul>
<li>Click &quot;Services&quot; in the header and select &quot;Relational Database Service.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/6-rds-in-header.png" alt="Screen shot with red arrow pointing to Relational Database Serivce in the Services list" /></p>
<p>Before creating any instances, you need to create a DB Subnet Group so AWS knows where to place your instance.</p>
<ul>
<li>Select &quot;Subnet groups&quot; in the RDS Dashboard sidebar</li>
<li>Click the &quot;Create DB Subnet Group&quot; button</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/6.1-db-subnet-group.png" alt="Screen shot of the RDS sidebar with a red arrow pointing to "Subnet groups"" /></p>
<ul>
<li>Enter a useful subnet group name and description</li>
<li>Select your VPC</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/6.3-subnet-group-details.png" alt="Screen shot of the "Subnet group details" configuration window" /></p>
<ul>
<li>Select an availability zone you used above and select a subnet you created in that zone</li>
<li>Click &quot;Add subnet&quot;</li>
<li>Do this for both subnets you created above</li>
<li>Click the &quot;Create&quot; button</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/6.4-select-subnets.png" alt="Screen shot of the "Add subnets" configuration window" /></p>
<p>Now that you've created the database subnets, you need to create a database instance for your application to use.</p>
<ul>
<li>Return to the RDS Dashboard</li>
<li>Scroll down and click the &quot;Launch a DB instance&quot; button</li>
<li>For Airwaze, you will use a PostgreSQL database
<ul>
<li>Select PostgreSQL</li>
<li>Click &quot;Next&quot;</li>
</ul></li>
</ul>
<p><img src="../../materials/week05/lb-cloud/8-select-postgres.png" alt="Screen shot of the "Engine options" window" /></p>
<ul>
<li>AWS will next ask you how you plan to use the database. Production-ready databases will have multiple availability zone redundancy and higher-speed storage options, but are also more expensive. Select &quot;Dev/Test&quot; to access the lower-powered options then click &quot;Next.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/9-select-dev-test.png" alt="Screen shot of the "Use case" window" /></p>
<ul>
<li>Make sure the DB engine version matches the version of PostgreSQL you need to use.</li>
<li>Select <code>db.t2.micro</code> instance class. This is the smallest, slowest, and least-expensive instance option for RDS.</li>
<li>For this studio, select &quot;No&quot; for a Multi-AZ deployment. In a production environment, this is an important option to ensure the database is always accessible. For this studio, you do not need this.</li>
<li>The studio database is very small. Use the smallest storage option.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/10-instance-class.png" alt="Screen shot of the instance class configuration window for RDS" /></p>
<p>Next, you'll set up the instance's identifier and master user account. Do not set up the application user as the master user. That would introduce a security risk for your database and data if your application were to be compromised. You will set up a separate DB user account later.</p>
<ul>
<li>Give your DB instance a useful name in the <code>DB instance identifier</code> field.</li>
<li>Make a master username that is difficult to guess, but easy for you to remember.</li>
<li>Use a secure password for your master user.</li>
<li>Click &quot;Next.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/11-db-instance-settings.png" alt="Screen shot of the RDS instance "Settings" configuration window" /></p>
<p>Here you'll indicate where RDS should place your instance and how to secure it.</p>
<ul>
<li>Select your VPC.</li>
<li>Select the DB Subnet Group you made above.</li>
<li>Do not make your DB publicly accessible. For security, you should limit the services that can be accessed from outside your VPC.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/12-db-instance-vpc.png" alt="Screen shot of the RDS instance "Network & Security" configuration window" /></p>
<ul>
<li>Set up your desired database name and port.</li>
<li>
<p>Keep the default DB parameter group.</p>
</li>
<li>Click &quot;Launch DB instance&quot;.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/13-db-options.png" alt="Screen shot of the RDS instance "Database options" configuration window" /></p>
<p>RDS will start creating a DB instance, security groups, and your master user and database. Return to the RDS Instances dashboard and select your instance. Scroll down to the &quot;Connect&quot; section. Your Endpoint will appear here when the instance is ready. Note this endpoint address.</p>
<p>You'll also see the security group inbound and outbound rules set up. If the inbound rule doesn't match your VPC's subnet CIDR, change that by clicking the gear icon to the right of <code>Security group rules</code>.</p>
<p><img src="../../materials/week05/lb-cloud/15-db-instance-dns.png" alt="Screen shot of the RDS Dashboard "Connect" sub-window with a red circle around the instance endpoint" /></p>
<ul>
<li>Select the &quot;Inbound&quot; rules tab</li>
<li>Click &quot;Edit&quot;</li>
<li>
<p>Find the PostgreSQL port line</p>
<ul>
<li>Change its Source to your VPC subnet CIDR</li>
<li>This will allow traffic from all instances in your VPC, but not from the outside world.</li>
</ul>
</li>
<li>Click &quot;Save&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/allow-db-internal-only.png" alt="Screen shot of the PostgreSQL inbound rules with a red circle around the VPC's subnet CIDR" /></p>
<h2 id="make-a-custom-snapshot">Make a Custom Snapshot</h2>
<p>Now that you have created your database, you need to create an instance to connect to it as our template. If you need review on creating an EC2 instance, please see the previous lesson and studio.</p>
<p>You'll follow the same steps as before, with a few changes that are described here.</p>
<ul>
<li>On the &quot;Configure Instance Details&quot; screen while creating your instance:
<ul>
<li>Select your VPC in the &quot;Network&quot; selection.</li>
<li>Select your Public subnet.</li>
<li>Enable auto-assigning a Public IP.</li>
</ul></li>
</ul>
<p><img src="../../materials/week05/lb-cloud/16-select-your-vpc-and-public-subnet.png" alt="Screen shot of the "Configure INstnace Details" screen" /></p>
<ul>
<li>At the bottom of the &quot;Configure Instance Details&quot; screen is a collapsed area called &quot;Advanced Details.&quot; Click the text &quot;Advanced Details&quot; to expand this.</li>
<li>You will see a &quot;User data&quot; section. This is an area to specify extra configuration AWS should perform when launching your instance. Below is a script to configure many things for your application:
<ul>
<li>Installs Java</li>
<li>Creates the <code>airwaze</code> system user</li>
<li>Creates the application and configuration directories</li>
<li>Writes the airwaze configuration file, which includes the environment variables for the application</li>
<li>Writes the <code>systemd</code> service file</li>
<li>Prepares the service for execution</li>
</ul></li>
<li>This script is run as <code>root</code>, so <code>sudo</code> is not needed for these commands. That also means you must be careful when crafting a script to run here.</li>
<li>Copy this script in the &quot;User data&quot; section and adjust the <code>APP_DB_HOST</code> to your RDS instance's endpoint.</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/add-user-data-script-to-instance.png" alt="Screen shot of the "Advanced Details" section of the "Configure Instance Details" screen" /></p>
<pre><code class="language-nohighlight">#!/bin/bash
# Install Java
apt-get update -y &amp;&amp; apt-get install -y openjdk-8-jdk

# Create airwaze user
useradd -M airwaze
mkdir /opt/airwaze
mkdir /etc/opt/airwaze
chown -R airwaze:airwaze /opt/airwaze /etc/opt/airwaze
chmod 777 /opt/airwaze

# Write Airwaze config file
cat &lt;&lt; EOF &gt; /etc/opt/airwaze/airwaze.config
APP_DB_HOST=rds-instance.us-east-2.rds.amazonaws.com
APP_DB_PORT=5432
APP_DB_NAME=airwaze_db
APP_DB_USER=airwaze_user
APP_DB_PASS=verysecurepassword
EOF

# Write systemd unit file
cat &lt;&lt; EOF &gt; /etc/systemd/system/airwaze.service
[Unit]
Description=Airwaze Studio
After=syslog.target

[Service]
User=airwaze
EnvironmentFile=/etc/opt/airwaze/airwaze.config
ExecStart=/usr/bin/java -jar /opt/airwaze/app.jar SuccessExitStatus=143
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable airwaze.service</code></pre>
<ul>
<li>Continue through the steps to create the instance that you learned in the last lesson and studio.</li>
<li>Once the instance is online, copy the Airwaze application jar and database initialization CSV files to the server.</li>
<li>SSH to the instance and set the appropriate permissions on the jar.
<pre><code class="language-nohighlight">$ scp -i ~/.ssh/aws-ssh-key.pem airwaze-application.jar ubuntu@ec2-instance.us-east-2.compute.amazonaws.com:/opt/airwaze/app.jar
$ scp -i ~/.ssh/aws-ssh-key.pem routes.csv ubuntu@ec2-instance.us-east-2.compute.amazonaws.com:/home/ubuntu/routes.csv
$ scp -i ~/.ssh/aws-ssh-key.pem Airports.csv ubuntu@ec2-instance.us-east-2.compute.amazonaws.com:/home/ubuntu/Airports.csv
$ ssh -i ~/.ssh/aws-ssh-key.pem ubuntu@ec2-instance.us-east-2.compute.amazonaws.com
$ chmod 555 /opt/airwaze/app.jar</code></pre></li>
</ul>
<p>Now that you have your instance set up and ready, you need to log into the server to prepare your database and start the service. During development of the Airwaze studio application, it was set to reload the database on every start of the service. This is not something you want happening in your cloud environment. Instead, you'll create everything your application needs in your instance by hand.</p>
<ul>
<li>SSH to your instance, then install the <code>postgresql</code> client package.</li>
<li>
<p>Connect to your RDS instance using the master account you created before.</p>
<pre><code class="language-nohighlight">$ sudo apt-get update
$ sudo apt-get install postgresql
$ psql -h rds-instance.us-east-2.rds.amazonaws.com -p 5432 -U rds_master_user airwaze_db</code></pre>
</li>
<li>In the <code>psql</code> console, create:
<ul>
<li>The application's DB user</li>
<li>The postgis extensions</li>
<li>The data tables</li>
</ul></li>
<li>Then set your tables to be owned by your application's DB user.
<pre><code class="language-nohighlight">CREATE USER airwaze_user WITH PASSWORD 'verysecurepassword';
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;
CREATE EXTENSION fuzzystrmatch;
CREATE EXTENSION postgis_tiger_geocoder;
CREATE TABLE airport
(
id serial primary key,
airport_id integer,
airport_lat_long geometry,
altitude integer,
city character varying(255),
country character varying(255),
faa_code character varying(255),
icao character varying(255),
name character varying(255),
time_zone character varying(255)
);
CREATE TABLE route
(
id serial primary key,
airline character varying(255),
airline_id integer,
dst character varying(255),
dst_id integer,
route_geom geometry,
src character varying(255),
src_id integer
);
ALTER TABLE airport OWNER to airwaze_user;
ALTER TABLE route OWNER to airwaze_user;</code></pre></li>
</ul>
<p>Now that the tables are created, you need to fill them with data.</p>
<ul>
<li>Run the following commands to copy from your CSV files into the database. (You'll find the password along with the user you just created above).</li>
</ul>
<pre><code class="language-nohighlight">$ psql -h rds-instance.us-east-2.rds.amazonaws.com -d airwaze_db -U airwaze_user -c "\copy route(src, src_id, dst, dst_id, airline, route_geom) from STDIN DELIMITER ',' CSV HEADER" &lt; /home/ubuntu/routes.csv

$ psql -h rds-instance.us-east-2.rds.amazonaws.com -d airwaze_db -U airwaze_user -c "\copy airport(airport_id, name, city, country, faa_code, icao, altitude, time_zone, airport_lat_long) from STDIN DELIMITER ',' CSV HEADER" &lt; /home/ubuntu/Airports.csv</code></pre>
<p>At this point, everything is ready to go on this instance. You no longer need (or want) to connect to the database directly so uninstall the <code>postgresql</code> client package. Then you may start the Airwaze service.  </p>
<pre><code class="language-nohighlight">$ sudo apt-get remove postgresql
$ sudo systemctl start airwaze.service</code></pre>
<p>You can run <code>journalctl</code> as you learned in the previous studio to check the logs for your running service.</p>
<h2 id="configure-the-security-group">Configure the Security Group</h2>
<p>Now that your instance and service are running, return to the EC2 Security Group dashboard. Here you need to enable web access and remove SSH access. This will make your application usable to the world and decrease the risk of unintended access.</p>
<ul>
<li>Find and select your instance's security group</li>
<li>Select the &quot;Inbound&quot; traffic tab</li>
<li>Click &quot;Edit&quot;</li>
<li>Change to &quot;Custom TCP Rule&quot;</li>
<li>Enter port 8080</li>
<li>Select &quot;My IP&quot; for Source
<ul>
<li>This is where you would typically make the port accessible to the world, but only you need to access the studio instance for now.</li>
</ul></li>
<li>Click &quot;Save.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/swap-web-for-ssh.png" alt="Screen shot of the inbound rules for the instance security group" /></p>
<p>You may now try to access your application at <a href="http://ec2-instance.us-east-2.compute.amazonaws.com:8080" target="_blank">http://ec2-instance.us-east-2.compute.amazonaws.com:8080</a> in your browser.</p>
<h2 id="take-a-snapshot">Take a Snapshot</h2>
<p>The benefit of the cloud is more than just having an application running on a single server in the cloud. You can make your application more resilient by having it run on multiple servers with a load balancer transferring traffic to the least-used server.</p>
<p>To facilitate spinning up more instances, you can take an image of your current instance to start others.</p>
<ul>
<li>Return to the EC2 Instances Dashboard</li>
<li>Select your instance</li>
<li>Click &quot;Actions&quot;, then &quot;Image&quot;, then &quot;Create Image&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/create-image-menu.png" alt="Screen shot of the EC2 Instances dashboard with the Actions menu open" /></p>
<ul>
<li>Give your image a useful name so you can find it again later.</li>
<li>Give your image a helpful description.</li>
<li>Ensure &quot;No reboot&quot; is <strong>not</strong> selected.
<ul>
<li>Taking an image of a running instance is risky as it may catch it in the middle of writing to a file. Just leave this as &quot;No reboot&quot; unless there's a valid reason to not.</li>
</ul></li>
<li>Click &quot;Create Image.&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/create-image-popup.png" alt="Screen shot of the "Create Image" configuration window" /></p>
<p>AWS will then shut down your instance, take an image of it, then restart it. Click the link in the confirmation dialog to montior the process of the image creation.</p>
<p><img src="../../materials/week05/lb-cloud/create-image-pending.png" alt="Screen shot of the Create Image success dialog with a red line below the pending image ami" /></p>
<p>Once the image creation is complete, you can launch new instances with this image.</p>
<ul>
<li>Select your Amazon Machine Image (AMI)</li>
<li>Click &quot;Launch&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/launch-instance-from-image.png" alt="Screen shot of the AMIs dashboard with a red circle around "Launch"" /></p>
<p>This will start the familiar instance creation process, but with your image rather than the &quot;standard&quot; Ubuntu image you've been using. As before, on &quot;Configure Instance Details&quot;, select your VPC, public subnet, and assign a Public IP. This time, <strong><em>do not</em></strong> provide a User data script since this image already has the full configuration run.</p>
<p>After creating the instance, return to the EC2 Instances dashboard. Select your new instance and you'll see it was created from the image you created rather than the Ubuntu AMI used to create the previous one.</p>
<p><img src="../../materials/week05/lb-cloud/new-ami-id.png" alt="Screen shot of the EC2 Instances dashboard with a red line under the AMI ID of the new instance" /></p>
<h2 id="set-up-load-balancing">Set Up Load Balancing</h2>
<p>In order to connect a load balancer (LB), you need to have two public subnets in different availability zones. Return to the VPC Subnet dashboard.</p>
<ul>
<li>Click &quot;Create Subnet&quot;</li>
<li>Provide a useful name for the new subnet</li>
<li>Select your VPC</li>
<li>Pick a different availability zone than your other public subnet</li>
<li>Pick a new CIDR block</li>
<li>Click &quot;Yes, Create&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/lb-create-public-subnet.png" alt="Screen shot of the "Create Subnet" window" /></p>
<p>This new subnet is originally created as a private subnet, so you'll have to change its route table to allow connections with the internet.</p>
<ul>
<li>Click the &quot;Route Table&quot; tab</li>
<li>Click &quot;Edit&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/public-subnet-route-table.png" alt="Screen shot of the "Route Table" tab on the new subnet" /></p>
<ul>
<li>Change the Route Table selection to one with a target that starts with <code>igw</code>. This is your VPC's internet gateway.
<ul>
<li>An Internet Gateway allows communication between instances in your VPC and the internet.</li>
</ul></li>
<li>Click &quot;Save&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/change-to-public-route-table.png" alt="Screen shot showing a route table that includes an internet gateway" /></p>
<p>With the new public subnet in place, you can now create your LB.</p>
<ul>
<li>Return to the EC2 Dashboard</li>
<li>Select &quot;Load Balancers&quot; in the sidebar</li>
<li>Click &quot;Create Load Balancer&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/load-balancers-sidebar.png" alt="Screen shot of the EC2 Dashboard with a red arrow pointing to Load Balancers" /></p>
<ul>
<li>Find the Application Load Balancer</li>
<li>Click &quot;Create&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/application-load-balancer.png" alt="Screen shot of the "Select load balancer type" selection screen" /></p>
<ul>
<li>Provide a useful name for your LB</li>
<li>Select an internet-facing LB</li>
<li>Set your LB protocol to <code>HTTP</code> and port to <code>80</code></li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/basic-lb-configuration.png" alt="Screen shot of the "Configure Load Balancer" window" /></p>
<ul>
<li>Under &quot;Availability Zones&quot; select your VPC</li>
<li>Select the two public subnets you created</li>
<li>Click &quot;Next: Configure Security Settings&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/lb-availability-zones.png" alt="Screen shot of the Load Balancer "Availability Zones" window" /></p>
<p>The &quot;Configure Security Settings&quot; screen will likely encourage you to improve the LB's security. This is because you opted to only allow HTTP connections. This is sufficient for the studio, but you should enable HTTPS for every service that can support it in an enterprise environment. Click &quot;Next: Configure Security Groups&quot;.</p>
<p>You will be presented with a screen similar to one you used when creating your instances. This will allow you to configure the firewall to manage access to your LB.</p>
<ul>
<li>Create a new security group</li>
<li>Give the group a useful name and description</li>
<li>Select type <code>HTTP</code> and verify port 80 is selected</li>
<li>Make a custom source for 0.0.0.0/0, ::/0
<ul>
<li>This allows for all IPv4 and IPv6 sources to connect through this LB</li>
</ul></li>
<li>Click &quot;Next: Configure Routing&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/new-lb-security-group.png" alt="Screen shot of the Load Balancer "Configure Security Groups" window" /></p>
<p>The next screen allows you to define a target group for the routing behavior of the LB. This will determine what protocol and internal port it uses to communicate with your application servers.</p>
<ul>
<li>Select &quot;New target group&quot;</li>
<li>Give your new target group a useful name</li>
<li>Select port <code>8080</code> since that is the port Airwaze set up for listening</li>
<li>Select <code>instance</code> target type</li>
<li>Click &quot;Next: Register Targets&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/configure-lb-routing.png" alt="Screen shot of the Load Balancer "Target group" configuration window" /></p>
<p>Now, you need to register your application instances to your LB so it can route traffic correctly.</p>
<ul>
<li>Select your instances in the &quot;Instances&quot; section</li>
<li>Verify they are set to register for port 8080</li>
<li>Click &quot;Add to registered&quot; to add them to the LB</li>
<li>Click &quot;Save&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/register-instances-to-lb.png" alt="Screen shot of the Load Balancer "Target Instances" configuration window" /></p>
<p>At this point, AWS will begin configuring the LB. Find and note the DNS name they have assigned your LB.</p>
<p><img src="../../materials/week05/lb-cloud/lb/load-balancer-instance.png" alt="Screen shot of the Load Balancer Dashboard with a red circle around the new LB's DNS name" /></p>
<p>While the LB is starting up, you can configure your application instances to stop listening to the public internet and only to internal traffic.</p>
<ul>
<li>Return to the EC2 Security Groups Dashboard</li>
<li>Find your instance security group</li>
<li>Remove the SSH rule</li>
<li>Change the Source for the 8080 rule to listen only to your internal subnet</li>
<li>Click &quot;Save&quot;</li>
</ul>
<p><img src="../../materials/week05/lb-cloud/lb/make-instance-sg-internal-only.png" alt="Screen shot of the inbound rules for the application instances" /></p>
<p>Now it's time to see the result of your hard work:</p>
<p>Open <a href="http://demo-lb-instance.us-east-2.elb.amazonaws.com" target="_blank">http://demo-lb-instance.us-east-2.elb.amazonaws.com</a> in the browser and see the application running.</p>
<p>The real power in a load balancer is it can route traffic away from unhealthy instances. Time to test that out.</p>
<ul>
<li>Return to the EC2 Instances Dashboard</li>
<li>Locate your application instances</li>
<li>Select one instance
<ul>
<li>Click &quot;Actions&quot; -&gt; &quot;Instance State&quot; -&gt; &quot;Stop&quot;</li>
<li>Wait for the instance state to switch to Stop</li>
<li>Refresh the browser and see the application still works</li>
</ul></li>
<li>Stop your other instance
<ul>
<li>Refresh the browser and see the application no longer works</li>
</ul></li>
<li>Click &quot;Actions&quot; -&gt; &quot;Instance State&quot; -&gt; &quot;Start&quot; to restart one of your instances
<ul>
<li>Refresh the browser and see the application return to a working state</li>
<li>This step may take a while as the instance has to return to a good state and the LB has to verify the instance is healthy again before routing traffic</li>
</ul></li>
</ul>
<p>Congratulations! You have successfully created a load-balanced application in the cloud.</p>
<h2 id="bonus-mission">Bonus Mission</h2>
<p>There's no bonus mission today.  Use your time to work on your project or brush up on topics that you want to learn more about.</p>
                                    </section>

            </div>
        </main>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/highlight.pack.js"></script>
        <script type="text/javascript" src="https://education.launchcode.org/gis-devops/js/libgif.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');

                // Syntax highlighting
                hljs.configure({ displayLabels: true });
                hljs.initHighlightingOnLoad();
            });
        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', "UA-78748330-11", 'auto');
            ga('send', 'pageview');

        </script>

    </body>
</html>
