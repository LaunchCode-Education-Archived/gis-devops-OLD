---
title: "Studio: LaunchCart Part 2"
---

In this studio, we revisit the [LaunchCart application](https://gitlab.com/LaunchCodeTraining/launchcart) that we worked on in [yesterday's studio](../launchcart1/). We'll refactor the app to use Postgres and Flyway, and add a couple of features.

## Getting Started

Open up your `launchcart` project and make sure you are on the `master` branch and that your code is in a working state. To verify this, run your tests.

If you have any uncommitted changes, stash them using `git stash`. You can retrieve them later via `git stash pop`.

We'll work in a new branch for this studio, so run:

```nohighlight
$ git checkout -b launchcart2
```

## Your Tasks

Each section outlines one task or group of tasks for you to complete.

### Set Up A Postgres DB

From `psql`, create a Postgres database named `launchcart`. Then create a role with the same username and password (`launchcart`). Using insecure passwords for local development is generally acceptable. Be sure to grant all privileges on the `launchcart` database to the `launchcart` user.

### Configure the App To Use the Database

In your project, open `application.properties` and modify the database section to use the correct connection string, driver class, username, and password. You'll need to set these values properly:

- `spring.datasource.driver-class-name`
- `spring.datasource.url`
- `spring.datasource.username`
- `spring.datasource.password`

Then add the associated Postgres dependency to `build.gradle` as a compile-time dependency. As you're doing so, change the h2 dependency from a `compile` dependency to a `testCompile` dependency, since it will only be needed for running tests at this point.

Finally, since we'll be using Flyway to manage our database schema, we no longer want Hibernate to try to automatically manage the schema for us. Change the `spring.jpa.hibernate.ddl-auto` propertly in `application.properties` from `update` to `validate`.

### Configure Flyway

Your app now has all of the infrastructure to store entities in a Postgres database. The only thing keeping us from actually doing so a this point is having a database schema that reflects our model. To take care of this, you must first configure Flyway by:
- Adding the classpath depedency for Flyway's Gradle plugin to the `dependencies` section within the `buildscript` configuration of `build.gradle`.
- Add Postgres as a classpath dependency as well. This makes the Postgres driver available to Flyway outside of the context of your compiled, running Spring application.
- Adding the Flyway plugin to your `build.gradle`.
- Adding the info Flyway needs to connect to your database. This will be within a `flyway` section, as so:
    ```gradle
    flyway {
        url = '...'
        user = '...'
        password = '...'
    }
    ```

For specific details on any of these items, refer to documentation and course resources.

If you are successful, you will see a new group of Flyway tasks in the Gradle pane.

### Initial Migration

To create your first migration, which will set up your basic schema, first create the folder `src/main/resources/db/migration/`. Then create your first script within this directory in a file named `V2__InitialMigration.sql`.

<aside class="aside-note" markdown="1">
We mentioned previously that the version/ordering of your migrations is important for Flyway to run the in the correct order. Here, it may seem odd that we are starting with V2. When using Flyway within Spring Boot, V1 will be the first migration run in order to initialize the Flyway history table, so we start with the second version number.
</aside>

We could create this migration by inspecting the persistent model classes in our app, but that's a bit tedious. To take a shortcut, change the value of `spring.jpa.hibernate.ddl-auto` in `application.properties` from `validate` back to `update`. Then start up your application.

If you open a Postgres client (such as PSequel) you can then connect to your local database and inspect its structure as generated by Hibernate. Then you should:

- Create the contents of your initial migration to generate an identical schema as that one generated by Hibernate.
- Drop the tables generated by Hibernate and change `spring.jpa.hibernate.ddl-auto` back to `validate`
- Run the `flywayBaseline` Gradle task to initialize the Flyway history table. Note that this is the "V1" migration.
- Run your migration by running the `flywayMigrate` Gradle task.
- Start up the app and so a bit of functional testing.

<aside class="aside-hint" markdown="1">
Use `serial` as the data type for the `uid` columns. This implies the columns will be `int not null` and also creates a generating sequence for populating the column.
</aside>

A quick and easy way to test your `create table` commands is to run them in the Query pane of your Postgres client. If you're using PSequel, you'll need to refresh the tables pane in order to see your newly created table. Don't forget to delete them before running the migration via Flyway.

<aside class="aside-pro-tip" markdown="1">
One thing to keep in mind when writing these migration commands is that often the order of statments matters. For example, if a column in one table is a foreign key into another table, you'll need to create the referenced table first.
</aside>

Once this all works, commit your changes.

### Model Changes and Migrations

Now we'll get practice creating additional migrations.

Let's add a new boolean property to `Item` to keep track of whether or not an item is new.

- Modify the `testNewItemFormCreatesItemAndRedirects` test within `ItemControllerTests` to post an additional parameter, `newItem`, with value `"true"`.
- Add a boolean field `newItem` to `Item`, along with a getter and setter. Add `@NotNull` to the field.
- Run all of the tests to ensure that they pass.
- Write a new database migration script to add the column `is_new` to the `item` table. Be sure to set an apropriate default value for this column. This will ensure that any existing rows will have an appropriate value that isn't null set for the new column.
- Add a checkbox to `templates/item/new.html`:
    ```html
    <div class="form-group">
        <input type="checkbox" id="newItem" name="newItem" value="true" checked="checked" />
        <label for="newItem">New Item</label>
    </div>
    ```
- Run the app and ensure the New Item form submits, and that the chosen value is properly set in the database.
- Commit!

## Turning In Your Work

If you don't complete each of the tasks, turn in as much as you have completed by the end of the day.

- Commit and push your work to GitLab
- Notify the instructor that you are done